<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ServeSmartAI</title>

<!-- Modern font -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  :root{
    /* Neutral glassy theme with a calm accent */
    --bg: #0f1115;
    --bg-2: #0c0f14;
    --panel: #141a22;
    --surface: #161d27;
    --ink: #e9edf3;
    --muted: #9aa6b2;
    --ring: #263447;
    --accent: #6aa6ff;
    --accent-2: #7b7bff;
    --bubble-user: #1f2735;
    --bubble-ai: #121923;
    --shadow: 0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.02) inset;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--ink);
    background:
      radial-gradient(1400px 900px at 10% -10%, #25324a 0%, transparent 60%),
      radial-gradient(1000px 800px at 110% -10%, #1d2b45 0%, transparent 55%),
      linear-gradient(180deg, var(--bg), var(--bg-2));
  }

  /* Layout */
  .wrap { min-height: 100svh; display: grid; grid-template-rows: auto 1fr auto; }
  header {
    backdrop-filter: saturate(150%) blur(8px);
    background: linear-gradient(180deg, rgba(26,34,45,.65), rgba(20,26,34,.65));
    border-bottom: 1px solid var(--ring);
    padding: 14px clamp(14px, 2.5vw, 22px);
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
  }

  .brand {
    display: flex; align-items: center; gap: 10px;
  }
  .logo {
    width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: 0 8px 20px rgba(106,166,255,.35);
  }
  .title { margin: 0; font-weight: 600; font-size: 15px; letter-spacing: .2px; color: var(--ink); opacity: .95; }

  .controls {
    display: flex; align-items: center; gap: 10px;
  }
  .select {
    appearance: none;
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--ring);
    border-radius: 999px;
    padding: 10px 40px 10px 14px;
    font: inherit; font-size: 13px;
    position: relative;
    box-shadow: var(--shadow);
  }
  .select:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
  .controls .chev {
    pointer-events: none;
    margin-left: -34px;
    width: 12px; opacity: .7;
  }

  /* Chat panel */
  .panel {
    max-width: 900px; margin: 18px auto; width: 100%;
    display: grid; grid-template-rows: 1fr auto;
    border: 1px solid var(--ring);
    background: linear-gradient(180deg, #0f141c, #0e131a);
    border-radius: 18px;
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    overflow: hidden;
  }

  .messages {
    padding: clamp(14px, 2.5vw, 20px);
    overflow: auto;
  }
  .bubble {
    max-width: 76ch;
    border-radius: 16px;
    padding: 12px 14px;
    margin: 8px 0;
    line-height: 1.6;
    box-shadow: 0 1px 0 rgba(255,255,255,.02) inset, 0 10px 24px rgba(0,0,0,.25);
  }
  .user  { background: var(--bubble-user); border: 1px solid var(--ring); margin-left: auto; }
  .ai    { background: var(--bubble-ai);   border: 1px solid var(--ring); }
  .ai .copy {
    display: none; position: relative; float: right; margin-left: 8px;
    font-size: 12px; opacity: .65; cursor: pointer;
  }
  .ai:hover .copy { display: inline-block; }

  .composer {
    border-top: 1px solid var(--ring);
    display: grid; grid-template-columns: 1fr auto; gap: 10px;
    padding: 12px; background: linear-gradient(180deg, #0e131a, #0c1118);
  }
  .input {
    background: var(--surface); color: var(--ink);
    border: 1px solid var(--ring);
    border-radius: 12px;
    padding: 14px 16px;
    font: inherit; font-size: 14px;
    box-shadow: var(--shadow);
  }
  .input::placeholder { color: var(--muted); }
  .send {
    background: linear-gradient(180deg, var(--accent), #4b86ff);
    color: #0b1220;
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    font: inherit; font-weight: 600;
    cursor: pointer;
    box-shadow: 0 12px 30px rgba(106,166,255,.35);
  }
  .send:disabled { opacity: .6; cursor: default; }

  /* Mobile niceties */
  @media (max-width: 560px) {
    .panel { margin: 0; border-radius: 0; }
    .messages { padding-bottom: 8px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1 class="title">ServeSmartAI</h1>
    </div>

<div class="controls" title="Choose a model">
  <select id="model" class="select"></select>
  <svg class="chev" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M3 4.5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
  </svg>

  <!-- NEW: refresh button -->
  <button id="refresh" class="refresh" title="New chat">
    <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
      <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
      <path d="M3.5 9A9 9 0 0 1 18.3 5.6L23 10M1 14l4.7 4.4A9 9 0 0 0 20.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
    </svg>
  </button>
</div>

  <main class="panel">
    <div id="messages" class="messages"></div>
    <div class="composer">
      <input id="prompt" class="input" placeholder="Write your message" autocomplete="off" />
      <button id="send" class="send">Send</button>
    </div>
  </main>

  <footer style="opacity:.55; font-size:12px; text-align:center; padding:10px;">
    Built with Straico models. Keys stay server side.
  </footer>
</div>

<script>
  // Elements
  const modelSel = document.getElementById('model');
  const messagesEl = document.getElementById('messages');
  const promptEl = document.getElementById('prompt');
  const sendBtn = document.getElementById('send');

  // No system prompt, raw access
  const history = []; // [{role:'user'|'assistant', content:'...'}]

  // UI helpers
  function addBubble(text, who) {
    const b = document.createElement('div');
    b.className = 'bubble ' + (who === 'user' ? 'user' : 'ai');
    const copy = document.createElement('span');
    copy.className = 'copy';
    copy.textContent = 'Copy';
    copy.onclick = () => navigator.clipboard.writeText(text);
    b.textContent = text;
    if (who !== 'user') b.appendChild(copy);
    messagesEl.appendChild(b);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function addTyping() {
    const b = document.createElement('div');
    b.className = 'bubble ai';
    b.textContent = 'â€¦';
    messagesEl.appendChild(b);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return b;
  }

  // Load models from your secure endpoint
  async function loadModels() {
    try {
      const r = await fetch('/api/straico/models');
      const data = await r.json();
      const list = Array.isArray(data?.data) ? data.data : [];
      modelSel.innerHTML = '';
      list.forEach(m => {
        if (!m?.model) return;
        const o = document.createElement('option');
        o.value = m.model;
        o.textContent = m.name || m.model;
        modelSel.appendChild(o);
      });
      // Prefer these if present, else first item
      const preferred = ['openai/gpt-4o-mini', 'anthropic/claude-3.5-sonnet'];
      const found = preferred.find(p => [...modelSel.options].some(o => o.value === p));
      modelSel.value = found || modelSel.options[0]?.value || '';
    } catch {
      // Fallback minimal set if listing fails
      ['openai/gpt-4o-mini'].forEach(id => {
        const o = document.createElement('option'); o.value = id; o.textContent = id;
        modelSel.appendChild(o);
      });
    }
  }

  // Send via proxy
  async function send() {
    const text = promptEl.value.trim();
    if (!text || !modelSel.value) return;

    promptEl.value = '';
    sendBtn.disabled = true;

    history.push({ role:'user', content:text });
    addBubble(text, 'user');
    const thinking = addTyping();

    try {
      const r = await fetch('/api/straico/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          model: modelSel.value,
          messages: history,
          stream: false
        })
      });

      const payload = await r.text();
      let data; try { data = JSON.parse(payload); } catch { data = { raw: payload }; }

      if (!r.ok) {
        thinking.remove();
        const err = data?.response?.error || data?.error || payload;
        addBubble('Error ' + r.status + ': ' + err, 'ai');
        return;
      }

      const reply = data?.choices?.[0]?.message?.content
        || data?.response?.completion?.choices?.[0]?.message?.content
        || data?.response?.text
        || 'No content returned.';
      thinking.remove();
      history.push({ role:'assistant', content: reply });
      addBubble(reply, 'ai');

    } catch (e) {
      thinking.remove();
      addBubble('Network error. Please try again.', 'ai');
    } finally {
      sendBtn.disabled = false;
      promptEl.focus();
    }
  }

  sendBtn.addEventListener('click', send);
  promptEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });

  // Boot
  loadModels();
</script>
</body>
</html>
